---
import { getCollection } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import PostCard from '@/components/PostCard.astro';
import { estimateReadingTime } from '@/utils/estimateReadingTime';

const toTitleCase = (str: string) => str.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');

const blogPosts = (await getCollection('blog')).filter(p => !p.data.isDraft).sort((a,b)=> b.data.publishedAt.getTime() - a.data.publishedAt.getTime());

// Inject reading time (if not stored yet)
const enriched = blogPosts.map(p => {
  if(!p.data.readingTimeMinutes){
    const stats = estimateReadingTime(p.body);
    return { ...p, data: { ...p.data, readingTimeMinutes: stats.minutes } };
  }
  return p;
});

// Collect all unique tags
const allTags = [...new Set(enriched.flatMap(p => p.data.tags))].sort();

// Pass all posts to client-side for filtering
const postsData = enriched.map(p => ({
  slug: p.slug,
  title: p.data.title,
  description: p.data.description,
  publishedAt: p.data.publishedAt.toISOString(),
  tags: p.data.tags
}));
---
<Layout title="Blog | Siddhant Shah" description="Articles, write-ups & thoughts">
  <main class="flex flex-col gap-16">
    <section class="flex flex-col gap-8">
      <header class="flex w-full flex-col gap-3">
        <h1 class="text-4xl md:text-5xl font-bold gradient-text">Blog</h1>
        <p class="text-lg text-neutral-300 leading-relaxed">Long-form posts, experiments & deeper dives into finance, tech, and quantitative analysis.</p>
      </header>
    
      {allTags.length > 0 && (
        <div class="flex flex-wrap gap-2" id="tag-filters">
          <button data-tag="" class="tag-filter glass-btn bg-finance-cyan/10 text-finance-cyan border-finance-cyan/30">All</button>
          {allTags.map(tag => (
            <button data-tag={tag} class="tag-filter glass-btn text-neutral-300 hover:text-white hover:border-finance-cyan/30">{toTitleCase(tag)}</button>
          ))}
        </div>
      )}

      <p id="tag-message" class="text-sm text-finance-cyan hidden"></p>

      <section id="posts-container" class="flex flex-col gap-2 md:flex-row md:flex-wrap">
        {enriched.map(post => (
          <PostCard
            publishedAt={post.data.publishedAt}
            title={post.data.title}
            description={post.data.description}
            slug={post.slug}
          />
        ))}
      </section>

      <p id="no-posts-message" class="text-neutral-400 hidden">No posts found for this tag.</p>
    </section>
  </main>

  <script define:vars={{ postsData }}>
    function toTitleCase(str) {
      return str.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
    }

    const posts = postsData;
    const container = document.getElementById('posts-container');
    const tagMessage = document.getElementById('tag-message');
    const noPostsMessage = document.getElementById('no-posts-message');
    const tagFilters = document.querySelectorAll('.tag-filter');

    function renderPosts(filtered, selectedTag) {
      if (filtered.length === 0) {
        container.classList.add('hidden');
        noPostsMessage.classList.remove('hidden');
        return;
      }

      container.classList.remove('hidden');
      noPostsMessage.classList.add('hidden');

      container.innerHTML = filtered.map(post => {
        const date = new Date(post.publishedAt).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '/');
        return `
          <a class="group flex cursor-pointer flex-col gap-2 w-full md:w-[49%] rounded-xl border border-neutral-500 p-4 transition-all duration-200 hover:-translate-y-2 hover:border-neutral-200 hover:bg-slate-600 hover:bg-opacity-40 hover:text-neutral-100" href="/blog/${post.slug}">
            <div class="flex w-full flex-col justify-between gap-2 md:flex-row md:items-center">
              <p class="text-neutral-100 text-lg">${post.title}</p>
              <div class="flex flex-row items-center gap-4">
                <p>${date}</p>
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" class="transition-all duration-200 group-hover:translate-x-1">
                  <path d="M5.25 12.75L12.75 5.25" stroke="#999999" stroke-linecap="round" stroke-linejoin="round"></path>
                  <path d="M5.25 5.25H12.75V12.75" stroke="#999999" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </div>
            </div>
            <p class="truncate">${post.description}</p>
          </a>
        `;
      }).join('');

      if (selectedTag) {
        tagMessage.innerHTML = `Showing posts tagged with <strong class="text-neutral-200">${toTitleCase(selectedTag)}</strong>`;
        tagMessage.classList.remove('hidden');
      } else {
        tagMessage.classList.add('hidden');
      }
    }

    function filterByTag(tag) {
      const filtered = tag ? posts.filter(p => p.tags.includes(tag)) : posts;
      
      // Update URL without reload
      const url = new URL(window.location);
      if (tag) {
        url.searchParams.set('tag', tag);
      } else {
        url.searchParams.delete('tag');
      }
      window.history.pushState({}, '', url);

      // Update button states
      tagFilters.forEach(btn => {
        const btnTag = btn.dataset.tag;
        if (btnTag === tag) {
          btn.classList.remove('bg-neutral-800', 'text-neutral-400');
          btn.classList.add('bg-neutral-700', 'text-neutral-100');
        } else {
          btn.classList.remove('bg-neutral-700', 'text-neutral-100');
          btn.classList.add('bg-neutral-800', 'text-neutral-400', 'hover:bg-neutral-700');
        }
      });

      renderPosts(filtered, tag);
    }

    // Set up click handlers
    tagFilters.forEach(btn => {
      btn.addEventListener('click', () => {
        const tag = btn.dataset.tag;
        filterByTag(tag);
      });
    });

    // Check URL on load
    const urlParams = new URLSearchParams(window.location.search);
    const initialTag = urlParams.get('tag');
    if (initialTag) {
      filterByTag(initialTag);
    }
  </script>
</Layout>
