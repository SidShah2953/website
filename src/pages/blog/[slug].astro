---
import { getCollection } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import { estimateReadingTime } from '@/utils/estimateReadingTime';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts
    .filter(p => !p.data.isDraft)
    .map(p => ({ params: { slug: p.slug }, props: { entry: p } }));
}

const { entry } = Astro.props;
const stats = estimateReadingTime(entry.body);
const { Content } = await entry.render();
---
<Layout title={entry.data.title + ' | Siddhant Shah'} description={entry.data.description}>
  <link
    slot="head"
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"
    integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ"
    crossorigin="anonymous"
  />
  <script slot="head" defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "e709a605fa1c4a3895e2987e5a9ca9c6"}'></script>
  {import.meta.env.PROD && <script slot="head" data-goatcounter="https://siddhants.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>}
  <main class="flex flex-col lg:flex-row gap-8 max-w-7xl mx-auto w-full">
    <!-- Main Content -->
    <article class="post glass-card p-8 md:p-12 relative overflow-hidden flex-1 min-w-0">
      <!-- Decorative gradient -->
      <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-finance-blue/10 to-finance-purple/10 blur-3xl rounded-full"></div>
      
      <header class="flex w-full flex-col gap-4 relative z-10">
        <h1 class="text-4xl md:text-5xl font-bold gradient-text leading-tight">{entry.data.title}</h1>
        <p class="text-lg text-neutral-300">{entry.data.description}</p>
        <p class="text-sm text-neutral-400">
          Written by Siddhant Shah on <time datetime={entry.data.publishedAt.toISOString()}>{entry.data.publishedAt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
        </p>
        <div class="flex flex-wrap gap-4 text-sm text-neutral-400 items-center">
          <span class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {stats.minutes} min read
          </span>
          {entry.data.tags.length > 0 && (
            <span class="flex gap-2 flex-wrap">
              {entry.data.tags.map(tag => (
                <a href={`/blog?tag=${encodeURIComponent(tag)}`}
                   class="px-3 py-1 rounded-lg bg-finance-blue/10 text-finance-blue border border-finance-blue/30 hover:bg-finance-purple/20 hover:border-finance-purple/50 transition-all text-xs font-medium">
                  {tag}
                </a>
              ))}
            </span>
          )}
        </div>
      </header>
      <div class="relative z-10 mt-8">
        <Content />
      </div>
    </article>

    <!-- Table of Contents Sidebar -->
    <aside class="lg:w-80 order-first lg:order-last">
      <nav class="glass-card p-6 relative overflow-hidden lg:sticky lg:bottom-8 lg:max-h-[calc(100vh-4rem)] lg:overflow-y-auto">
        <div class="absolute top-0 left-0 w-32 h-32 bg-gradient-to-br from-finance-blue/5 to-finance-purple/5 blur-2xl rounded-full"></div>
        <h2 class="text-xl font-semibold gradient-text mb-4 relative z-10">Table of Contents</h2>
        <div id="toc-container" class="relative z-10"></div>
      </nav>
    </aside>
  </main>
  
  <script>
    // Generate hierarchical TOC from headings
    const article = document.querySelector('.post');
    const tocContainer = document.getElementById('toc-container');
    if (article && tocContainer) {
      const headings = article.querySelectorAll('h2, h3');
      if (headings.length > 0) {
        const ol = document.createElement('ol');
        ol.className = 'space-y-2 text-sm';
        
        let currentH2Li: HTMLLIElement | null = null;
        let currentH3Ol: HTMLOListElement | null = null;
        
        headings.forEach((heading, index) => {
          const id = heading.id || `heading-${index}`;
          heading.id = id;
          
          if (heading.tagName === 'H2') {
            // Create H2 list item
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = `#${id}`;
            a.textContent = heading.textContent;
            a.className = 'text-finance-cyan hover:text-white transition-colors font-medium block py-1';
            li.appendChild(a);
            ol.appendChild(li);
            currentH2Li = li;
            currentH3Ol = null;
          } else if (heading.tagName === 'H3' && currentH2Li) {
            // Create nested list for H3 if it doesn't exist
            if (!currentH3Ol) {
              currentH3Ol = document.createElement('ol');
              currentH3Ol.className = 'ml-0 mt-1 space-y-1';
              currentH2Li.appendChild(currentH3Ol);
            }
            // Create H3 list item
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = `#${id}`;
            a.textContent = heading.textContent;
            a.className = 'text-neutral-400 hover:text-neutral-300 transition-colors block py-1 pl-4';
            li.appendChild(a);
            currentH3Ol.appendChild(li);
          }
        });
        
        tocContainer.appendChild(ol);
      }
    }
  </script>
</Layout>
