---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import formatDate from "@/utils/formatDate";

export async function getStaticPaths() {
  const projects = await getCollection("projects");

  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project: project },
  }));
}

type Props = {
  project: CollectionEntry<"projects">;
};

const { project } = Astro.props;
const { Content } = await project.render();
---
<link
rel="stylesheet"
href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"
integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ"
crossorigin="anonymous"
/>
<Layout title={project.data.title} description={project.data.description}>
  {import.meta.env.PROD && <script slot="head" data-goatcounter="https://siddhants.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>}
  <main class="flex flex-col lg:flex-row gap-8 max-w-7xl mx-auto w-full">
    <!-- Main Content -->
    <article class="project glass-card p-8 md:p-12 relative overflow-hidden flex-1 min-w-0">
      <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-finance-blue/10 to-finance-purple/10 blur-3xl rounded-full"></div>
      
      <header role="presentation" class="relative z-10">
        <h1 class="text-4xl md:text-5xl font-bold gradient-text leading-tight">
          {project.data.title}
        </h1>
        <p class="text-lg text-neutral-300 mt-4 leading-relaxed">{project.data.description}</p>
        <div class="flex items-center gap-2 text-sm text-neutral-400 mt-4">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <time datetime={project.data.publishedAt.toISOString()}>{formatDate(project.data.publishedAt)}</time>
        </div>
      </header>
      
      <div class="relative z-10 mt-8">
        <Content />
      </div>
    </article>

    <!-- Table of Contents Sidebar -->
    <aside class="lg:w-80 order-first lg:order-last">
      <nav class="glass-card p-6 relative overflow-hidden lg:sticky lg:bottom-8 lg:max-h-[calc(100vh-4rem)] lg:overflow-y-auto">
        <div class="absolute top-0 left-0 w-32 h-32 bg-gradient-to-br from-finance-blue/5 to-finance-purple/5 blur-2xl rounded-full"></div>
        <h2 class="text-xl font-semibold gradient-text mb-4 relative z-10">Table of Contents</h2>
        <div id="toc-container" class="relative z-10"></div>
      </nav>
    </aside>
  </main>
  
  <script>
    // Generate hierarchical TOC from headings
    const article = document.querySelector('.project');
    const tocContainer = document.getElementById('toc-container');
    if (article && tocContainer) {
      const headings = article.querySelectorAll('h2, h3');
      if (headings.length > 0) {
        const ol = document.createElement('ol');
        ol.className = 'space-y-2 text-sm';
        
        let currentH2Li: HTMLLIElement | null = null;
        let currentH3Ol: HTMLOListElement | null = null;
        
        headings.forEach((heading, index) => {
          const id = heading.id || `heading-${index}`;
          heading.id = id;
          
          if (heading.tagName === 'H2') {
            // Create H2 list item
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = `#${id}`;
            a.textContent = heading.textContent;
            a.className = 'text-finance-cyan hover:text-white transition-colors font-medium block py-1';
            li.appendChild(a);
            ol.appendChild(li);
            currentH2Li = li;
            currentH3Ol = null;
          } else if (heading.tagName === 'H3' && currentH2Li) {
            // Create nested list for H3 if it doesn't exist
            if (!currentH3Ol) {
              currentH3Ol = document.createElement('ol');
              currentH3Ol.className = 'ml-0 mt-1 space-y-1';
              currentH2Li.appendChild(currentH3Ol);
            }
            // Create H3 list item
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = `#${id}`;
            a.textContent = heading.textContent;
            a.className = 'text-neutral-400 hover:text-neutral-300 transition-colors block py-1 pl-4';
            li.appendChild(a);
            currentH3Ol.appendChild(li);
          }
        });
        
        tocContainer.appendChild(ol);
      }
    }
  </script>
</Layout>